jobs:
  include:
    - name: VM
      os: linux-ppc64le
      dist: focal
    - name: container
      arch: ppc64le
      dist: focal

addons:
  snaps:
    - name: snapcraft
      channel: stable
      confinement: classic
    - name: lxd
      channel: stable

# before_script:
#   - cat /etc/subuid > tsubuid
#   - sudo echo "root:1000000:65536" >> tsubuid
#   - sudo cp tsubuid /etc/subuid
#   - rm -f tsubuid
  
#   - cat /etc/subuid > tsubgid
#   - sudo echo "root:1000000:65536" >> tsubgid
#   - sudo cp tsubgid /etc/subgid
#   - rm -f tsubgid
  
#   - sudo cat /etc/subuid
#   - sudo cat /etc/subgid
  
script:
  - sudo apt-get update -y 
#   - sudo apt-get purge 
  - sudo apt install snapd
  - sudo snap refresh lxd --channel=5.8/stable
  - sudo usermod --append --groups lxd $USER
  - sudo /snap/bin/lxd.migrate -yes
  - sudo lxd waitready
  - sudo lxd init --auto
  - sudo lxd init --dump
  - sudo lxc profile set default security.privileged true
  - export SNAPCRAFT_BUILD_ENVIRONMENT=lxd
  - export SNAPCRAFT_BUILD_INFO=1
  - cd ~
  - git clone https://github.com/anup-kodlekere/worker.git
  - cd worker
  - git checkout deploy_snap
#   - sg lxd -c snapcraft
#   - sudo snapcraft build --use-lxd

  - sudo lxc launch ubuntu:20.04 test
  - sudo lxc ls
  - sudo lxc exec test cat /etc/os-release
  - sudo lxc rm -f test
